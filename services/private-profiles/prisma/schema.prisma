// This is your Prisma schema file for the private-sessions service

generator client {
  provider = "prisma-client-js"
  output = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("PRIVATE_PROFILES_DATABASE_URL")
}

model ProfileSession {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  authorDid         String
  createdAt         DateTime  @default(now()) 
  expiresAt         DateTime
  revokedAt         DateTime?

  // Relationships
  sessionKeys       ProfileSessionKey[] @relation("ProfileSessionToSessionKeys")
  privateProfiles   PrivateProfile[] @relation("ProfileSessionToProfiles")

  @@index([authorDid, createdAt(sort: Desc)], name: "idx_profile_sessions_current")
  @@map("profile_sessions")
}

model ProfileSessionKey {
  sessionId    String @db.Uuid
  userKeyPairId String @db.Uuid
  recipientDid String
  encryptedDek Bytes
  createdAt    DateTime  @default(now()) 

  // Relationships
  session     ProfileSession @relation("ProfileSessionToSessionKeys", fields: [sessionId], references: [id])

  @@id([sessionId, recipientDid])
  @@index([recipientDid, sessionId, createdAt], name: "idx_profile_session_keys_by_recipient_session_created_at")
  @@index([sessionId, createdAt], name: "idx_profile_session_keys_with_session_created_at")
  @@index([userKeyPairId], name: "idx_profile_session_keys_with_user_key_pair_id")
  @@map("profile_session_keys")
}

model PrivateProfile {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId         String    @db.Uuid
  authorDid         String
  encryptedContent  Bytes
  avatarUri         String?
  bannerUri         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  session           ProfileSession   @relation("ProfileSessionToProfiles", fields: [sessionId], references: [id])

  @@index([authorDid], name: "idx_private_profiles_author")
  @@index([sessionId], name: "idx_private_profiles_session")
  @@map("private_profiles")
}

// Generates a broken ER diagram, see README.md if you
// need to update the diagram
// generator erd {
//  provider = "prisma-erd-generator"
// }