# Contribution & Testimonial Feature Specification
# This DSL defines the expected behavior for implementation validation

version: "1.0"
service: service-admin

# =============================================================================
# DATA MODELS
# =============================================================================

models:
  Contribution:
    description: "Tracks users who have contributed to Speakeasy"
    table_name: contributions
    fields:
      id:
        type: uuid
        primary_key: true
        auto_generate: true
      did:
        type: string
        description: "AT Protocol DID of the contributor"
        required: true
        indexed: true
      contribution:
        type: string
        values:
          - founding_donor   # Early donors during founding period
          - donor            # One-time or recurring donors
          - contributor      # Code, design, or other contributions
        required: true
        description: "Type of contribution (extensible in future)"
      details:
        type: json
        required: false
        description: "Additional details about the contribution"
        allowed_values:
          - "null - for founding_donor"
          - "{amount: number, donationId?: string} - for donor, amount in cents, optional Stripe donation ID"
          - "{feature: 'feature_name'} - for contributor, names the feature contributed to"
      createdAt:
        type: datetime
        default: now()
    indexes:
      - fields: [did, createdAt]
        name: idx_contribution_did_created
        description: "Supports filtering by did, or by did + createdAt range"

  Testimonial:
    description: "User-submitted messages about why they support Speakeasy"
    table_name: testimonials
    fields:
      id:
        type: uuid
        primary_key: true
        auto_generate: true
      did:
        type: string  # NOT uuid - DIDs are strings
        description: "AT Protocol DID of the testimonial author"
        required: true
        indexed: true
      content:
        type: json
        description: "Bluesky post content with text and optional facets"
        required: true
        format: |
          {
            text: string (max 300 chars),
            facets?: array (AT Protocol facets for mentions, hashtags, links)
          }
        notes: "Same structure as app.bsky.feed.post record"
      createdAt:
        type: datetime
        default: now()
    constraints:
      - type: foreign_key_check
        description: "Author must exist in contributions table (application-level, not DB FK)"
        validation: "did must have at least one entry in contributions.did"
    indexes:
      - fields: [did]
        name: idx_testimonial_did

# =============================================================================
# API ENDPOINTS
# =============================================================================

api:
  # ---------------------------------------------------------------------------
  # Testimonial Endpoints
  # ---------------------------------------------------------------------------

  createTestimonial:
    lexicon_id: social.spkeasy.actor.createTestimonial
    type: procedure
    auth: required
    description: "Create a testimonial for the authenticated user"
    input:
      content:
        type: object
        required: true
        description: "Bluesky post content"
        properties:
          text:
            type: string
            required: true
            max_length: 300
          facets:
            type: array
            required: false
            description: "AT Protocol facets for mentions, hashtags, links"
    output:
      id:
        type: string
        description: "UUID of created testimonial"
      createdAt:
        type: string
        format: iso8601
    errors:
      - code: NotContributor
        status: 403
        message: "You must be a contributor to create a testimonial"
        when: "Authenticated user has no entries in contributions table"
      - code: InvalidInput
        status: 400
        message: "Content.text is required and must be under 300 characters"
    behavior:
      - "Authenticated user's DID is used (not from input)"
      - "User can create multiple testimonials"
      - "Content stored as single JSON column with text + optional facets"

  listTestimonials:
    lexicon_id: social.spkeasy.actor.listTestimonials
    type: query
    auth: optional
    description: "List testimonials, optionally filtered by user"
    input:
      did:
        type: string
        required: false
        description: "Filter by specific user DID"
      limit:
        type: integer
        required: false
        default: 50
        max: 100
      cursor:
        type: string
        required: false
        description: "Pagination cursor"
    output:
      testimonials:
        type: array
        items:
          id: string
          did: string
          content: object  # {text: string, facets?: array}
          createdAt: string  # ISO8601
      cursor:
        type: string
        description: "Next page cursor, null if no more results"
    behavior:
      - "Returns testimonials ordered by createdAt descending (newest first)"
      - "Public endpoint - no auth required to read"
      - "Content returned as-is for client-side rendering"

  deleteTestimonial:
    lexicon_id: social.spkeasy.actor.deleteTestimonial
    type: procedure
    auth: required
    description: "Delete a testimonial"
    input:
      id:
        type: string
        required: true
        description: "UUID of testimonial to delete"
    output:
      success:
        type: boolean
    errors:
      - code: NotFound
        status: 404
        message: "Testimonial not found"
      - code: Forbidden
        status: 403
        message: "You can only delete your own testimonials"
        when: "Authenticated user's DID does not match testimonial.did"
    behavior:
      - "Only the author can delete their testimonial"
      - "Hard delete (not soft delete)"

  # ---------------------------------------------------------------------------
  # Contribution Endpoints
  # ---------------------------------------------------------------------------

  # NOTE: No addContribution API endpoint - use CLI for adding contributions
  # NOTE: No listContributions endpoint - contribution data accessed via CLI/DB only

  checkContribution:
    lexicon_id: social.spkeasy.actor.checkContribution
    type: query
    auth: required
    description: "Check if the authenticated user is a contributor"
    input: {}  # No input - uses authenticated user's DID
    output:
      isContributor:
        type: boolean
      contributions:
        type: array
        items: string
        description: "List of contribution types for this user"
    behavior:
      - "Uses authenticated user's DID (no input required)"
      - "Returns false and empty array if not a contributor"
      - "Returns true and list of contribution types if contributor"

# =============================================================================
# CLI TOOL
# =============================================================================

cli:
  name: addContribution
  description: "CLI tool for adding contribution entries (direct DB access)"
  location: services/service-admin/src/cli/addContribution.ts
  pattern: "Follow existing addInvite.ts pattern"

  implementation:
    - "Direct Prisma DB access (no API calls)"
    - "Simple argument parsing from process.argv"
    - "Add bin entry in package.json"
    - "Add postbuild chmod in package.json"

  usage: "addContribution <did> <contribution> [detail]"
  examples:
    - "addContribution did:plc:abc123 founding_donor"
    - "addContribution did:plc:abc123 donor 5000"
    - "addContribution did:plc:abc123 contributor 'dark-mode'"

  arguments:
    did:
      position: 1
      required: true
      description: "User's DID (e.g., did:plc:abc123)"
      validation: "Must start with 'did:'"
    contribution:
      position: 2
      required: true
      choices: [founding_donor, donor, contributor]
      description: "Contribution type"
    detail:
      position: 3
      required: "Required for donor and contributor types"
      description: "Amount in cents (for donor) or feature name (for contributor)"

  behavior:
    - "Validates DID format (must start with did:)"
    - "Validates contribution is one of allowed values"
    - "For donor: requires amount argument (integer), stores as {amount: number}"
    - "For contributor: requires feature argument, stores as {feature: 'name'}"
    - "For founding_donor: detail argument not allowed, details is null"
    - "Creates contribution entry directly via Prisma"
    - "Prints success message with created entry details"
    - "Exits with code 1 on error"
    - "Duplicates are allowed - each call creates a new entry"

  errors:
    - "Usage error if missing required arguments"
    - "Invalid contribution type error"
    - "Missing amount for donor type"
    - "Missing feature for contributor type"
    - "Detail provided for founding_donor type"
    - "Invalid amount (must be positive integer) for donor type"

  notes:
    - "No removal CLI - contribution entries are permanent"
    - "founding_donor is ONLY added via this CLI, never automatically"

# =============================================================================
# INTEGRATIONS
# =============================================================================

integrations:
  stripe_donation:
    description: "Auto-add donors as contributors after successful donation"
    trigger: "Successful Stripe payment completion"
    hook_location: "After donation checkout session completes"

    existing_code:
      file: services/service-admin/src/services/feature.service.ts
      method: donate
      notes: "Currently creates Stripe checkout session, need to add webhook handling"

    implementation:
      webhook:
        description: "Stripe webhook for checkout.session.completed"
        endpoint: /webhooks/stripe
        behavior:
          - "Verify webhook signature"
          - "Extract customer DID from session metadata"
          - "Extract donation ID (checkout session ID or payment intent ID) from Stripe event"
          - "Check for duplicate: query contributions where did=DID AND createdAt > (now - 30 days)"
          - "If any matching entry has same donationId in details, skip (duplicate webhook)"
          - "Otherwise, add contribution entry with contribution: donor"

    behavior:
      - "Only add contribution entry for successful payments"
      - "contribution type is always 'donor' for Stripe donations (NEVER founding_donor)"
      - "details set to {amount: amountInCents, donationId: stripeId}"
      - "DID must be stored in Stripe session metadata during checkout creation"
      - "Deduplication: check last 30 days for same donationId before inserting"
      - "Uses idx_contribution_did_created index for efficient 30-day lookups"

# =============================================================================
# BUSINESS RULES
# =============================================================================

business_rules:
  testimonials_require_contributor:
    description: "Users must be contributors to write testimonials"
    validation: "Check contributions table before creating testimonial"
    error: "NotContributor (403)"
    notes: "Checked at API level, not database FK"

  testimonials_not_editable:
    description: "Testimonials cannot be edited after creation"
    behavior: "Users must delete and recreate to change content"
    endpoints: "Only createTestimonial and deleteTestimonial, no update"

  multiple_testimonials_allowed:
    description: "Users can submit multiple testimonials over time"
    behavior: "No uniqueness constraint on did in testimonials"

  multiple_contributions_allowed:
    description: "Same user can have multiple contribution entries"
    example: "User can be donor multiple times (each donation creates a row)"
    constraint: "No uniqueness constraint - duplicates allowed for tracking individual contributions"

  contribution_types_extensible:
    description: "New contribution types may be added in future"
    current_values: [founding_donor, donor, contributor]
    implementation: "Use string field, not database enum for flexibility"

  details_by_contribution_type:
    description: "Details field constraints based on contribution type"
    rules:
      - "founding_donor: details must be null"
      - "donor: details must be {amount: number} (amount in cents)"
      - "contributor: details must be {feature: 'feature_name'}"

  founding_donor_manual_only:
    description: "founding_donor status is only assigned via CLI"
    behavior: "Never auto-assigned by Stripe donations or any other integration"
    reason: "Reserved for early contributors during founding period"

  contribution_entries_permanent:
    description: "Contribution entries cannot be removed"
    behavior: "No delete endpoint or CLI command for contributions"
    reason: "Historical record of support"

# =============================================================================
# VERIFICATION CHECKLIST
# =============================================================================

verification:
  database:
    - "contributions table exists with correct columns (id, did, contribution, details, createdAt)"
    - "contributions.details is JSON/JSONB type"
    - "Composite index on (did, createdAt) in contributions"
    - "testimonials table exists with correct columns (id, did, content, createdAt)"
    - "testimonials.did is string type (not UUID)"
    - "testimonials.content is JSON/JSONB type"
    - "Index on testimonials.did"

  api:
    - "createTestimonial returns 403 if user not in contributions"
    - "createTestimonial succeeds for users in contributions"
    - "Multiple testimonials can be created by same user"
    - "No updateTestimonial endpoint exists"
    - "listTestimonials returns public data without auth"
    - "deleteTestimonial only allows author to delete"
    - "checkContribution requires auth and uses authenticated user's DID"
    - "checkContribution returns correct contributor status and contribution types"

  integration:
    - "Stripe webhook creates contribution entry on successful donation"
    - "Stripe webhook assigns 'donor' contribution (never 'founding_donor')"
    - "Stripe webhook stores donationId in details JSON"
    - "Duplicate webhook with same donationId in last 30 days is skipped"
    - "DID is correctly passed through Stripe metadata"

  cli:
    - "addContribution <did> <contribution> [detail] creates contribution entry"
    - "addContribution validates DID format"
    - "addContribution validates contribution is one of allowed values"
    - "addContribution requires amount (integer) for donor type"
    - "addContribution requires feature name for contributor type"
    - "addContribution rejects detail arg for founding_donor type"
    - "addContribution allows duplicate entries"
    - "No removeContribution CLI exists"
